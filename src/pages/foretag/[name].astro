---
import Layout from '@/layouts/Layout.astro'
import { type CompanyData, isCompany, getCompanyURL } from '@/data/companyData'
import Company from '@/components/company/Company.astro'

const { name = '' } = Astro.params

/**
 * Conditionally load cached local JSON file instead of fetching from the API
 */
async function getCompanies() {
  let data: CompanyData[]

  if (process.env.NODE_ENV === 'production') {
    data = await fetch('https://api.klimatkollen.se/api/companies').then(
      (res) => res.json(),
    )
  } else {
    // prettier-ignore
    // @ts-ignore Don't care about this TS error
    data = (await import('@/data/test.json')).default as CompanyData[]
  }

  return (
    data
      .filter(isCompany)
      // HACK: Keep unique companies. This should ideally be solved with filtering on the API side.
      // IDEA: Maybe open an issue in garbo to let the API return proper data.
      .filter(
        (c, i, array) =>
          i === array.findLastIndex((company) => c.url === company.url),
      ) as CompanyData[]
  )
}

const companies = await getCompanies()
const company = companies.find(
  (company) =>
    company.companyName.toLowerCase().replaceAll(' ', '-') ===
    name.toLowerCase(),
)
---

<Layout title="Klimatkollen - få koll på företagens utsläpp">
  {company ? <Company {company} {companies} /> : null}

  {
    process.env.NODE_ENV === 'development' ? (
      <div class="mt-16 flex flex-wrap gap-2 text-nowrap px-8">
        {companies.map((c) => (
          <a href={getCompanyURL(c)} class="underline">
            {c.companyName}
          </a>
        ))}
      </div>
    ) : null
  }
</Layout>
